<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Absensi Karyawan</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
      }

      .card h2 {
        color: #4a5568;
        margin-bottom: 20px;
        font-size: 1.5em;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .video-container {
        position: relative;
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      #videoElement {
        width: 100%;
        height: auto;
        display: block;
      }

      .face-overlay {
        position: absolute;
        border: 3px solid #10b981;
        border-radius: 5px;
        background: rgba(16, 185, 129, 0.1);
        pointer-events: none;
        transition: all 0.2s ease;
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
      }

      .face-overlay::before {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 7px;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.05);
          opacity: 0.7;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .controls {
        margin: 20px 0;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .btn-group {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .btn-primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
      }

      .btn-success {
        background: linear-gradient(45deg, #10b981, #059669);
        color: white;
      }

      .btn-danger {
        background: linear-gradient(45deg, #ef4444, #dc2626);
        color: white;
      }

      .btn-warning {
        background: linear-gradient(45deg, #f59e0b, #d97706);
        color: white;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .status {
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-weight: 600;
      }

      .status.success {
        background: #d1fae5;
        color: #059669;
        border: 2px solid #10b981;
      }

      .status.error {
        background: #fee2e2;
        color: #dc2626;
        border: 2px solid #ef4444;
      }

      .status.info {
        background: #dbeafe;
        color: #2563eb;
        border: 2px solid #3b82f6;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #4a5568;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1em;
        transition: border-color 0.3s ease;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }
      }

      .tabs {
        display: flex;
        margin-bottom: 20px;
        background: #f7fafc;
        border-radius: 8px;
        padding: 4px;
      }

      .tab {
        flex: 1;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.3s ease;
        font-weight: 600;
      }

      .tab.active {
        background: white;
        color: #667eea;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .employee-info {
        background: #f7fafc;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        text-align: center;
      }

      .employee-info img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin-bottom: 10px;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .attendance-log {
        max-height: 300px;
        overflow-y: auto;
        background: #f7fafc;
        border-radius: 8px;
        padding: 15px;
      }

      .log-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .log-time {
        font-size: 0.9em;
        color: #64748b;
      }

      .face-detection-info {
        margin-top: 10px;
        padding: 10px;
        background: #f0fdf4;
        border-radius: 6px;
        border-left: 4px solid #10b981;
      }

      .employee-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #667eea;
      }

      .employee-card h4 {
        color: #4a5568;
        margin-bottom: 8px;
      }

      .employee-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        font-size: 0.9em;
        color: #64748b;
      }

      .employee-actions {
        margin-top: 10px;
        display: flex;
        gap: 10px;
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 0.8em;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover {
        color: black;
      }

      .search-box {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-users"></i> Sistem Absensi Karyawan</h1>
        <p>Sistem pengelolaan kehadiran berbasis pengenalan wajah</p>
      </div>

      <div class="main-content">
        <!-- Video Stream Card -->
        <div class="card">
          <h2><i class="fas fa-camera"></i> Kamera & Absensi</h2>
          <div class="video-container">
            <video id="videoElement" autoplay muted></video>
          </div>

          <div
            class="face-detection-info"
            id="faceDetectionInfo"
            style="display: none"
          >
            <div id="faceCount">Wajah terdeteksi: 0</div>
          </div>

          <div class="controls">
            <div class="btn-group">
              <button class="btn btn-primary" id="startCameraBtn">
                <i class="fas fa-play"></i> Mulai Kamera
              </button>
              <button class="btn btn-danger" id="stopCameraBtn" disabled>
                <i class="fas fa-stop"></i> Stop Kamera
              </button>
            </div>

            <div class="btn-group">
              <button class="btn btn-success" id="checkInBtn" disabled>
                <i class="fas fa-sign-in-alt"></i> Check In
              </button>
              <button class="btn btn-warning" id="checkOutBtn" disabled>
                <i class="fas fa-sign-out-alt"></i> Check Out
              </button>
            </div>
          </div>

          <div id="attendanceStatus"></div>
        </div>

        <!-- Registration & Management Card -->
        <div class="card">
          <div class="tabs">
            <div class="tab active" data-tab="register">
              <i class="fas fa-user-plus"></i> Registrasi
            </div>
            <div class="tab" data-tab="employees">
              <i class="fas fa-users"></i> Karyawan
            </div>
            <div class="tab" data-tab="roles">
              <i class="fas fa-user-tag"></i> Jabatan
            </div>
          </div>

          <!-- Registration Tab -->
          <div class="tab-content active" id="register">
            <form id="registrationForm">
              <div class="form-row">
                <div class="form-group">
                  <label for="employeeId">ID Karyawan*:</label>
                  <input
                    type="text"
                    id="employeeId"
                    required
                    placeholder="Masukkan ID karyawan"
                  />
                </div>
                <div class="form-group">
                  <label for="name">Nama Lengkap*:</label>
                  <input
                    type="text"
                    id="name"
                    required
                    placeholder="Masukkan nama lengkap"
                  />
                </div>
              </div>

              <div class="form-group">
                <label for="address">Alamat:</label>
                <textarea
                  id="address"
                  placeholder="Masukkan alamat lengkap"
                ></textarea>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="dateOfBirth">Tanggal Lahir:</label>
                  <input type="date" id="dateOfBirth" />
                </div>
                <div class="form-group">
                  <label for="phone">Telepon:</label>
                  <input
                    type="tel"
                    id="phone"
                    placeholder="Masukkan nomor telepon"
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="email">Email:</label>
                  <input type="email" id="email" placeholder="Masukkan email" />
                </div>
                <div class="form-group">
                  <label for="basicSalary">Gaji Pokok:</label>
                  <input
                    type="number"
                    id="basicSalary"
                    placeholder="Masukkan gaji pokok"
                    min="0"
                    step="1000"
                  />
                </div>
              </div>

              <div class="form-group">
                <label for="roleSelect">Jabatan:</label>
                <select id="roleSelect" class="form-control"></select>
              </div>

              <button
                type="submit"
                class="btn btn-primary"
                style="width: 100%"
                id="registerBtn"
              >
                <i class="fas fa-user-plus"></i> Daftar Karyawan
              </button>
            </form>
            <div id="registrationStatus"></div>
          </div>

          <!-- Employees Tab -->
          <div class="tab-content" id="employees">
            <div class="form-group">
              <input
                type="text"
                class="search-box"
                id="employeeSearch"
                placeholder="Cari karyawan berdasarkan nama, ID, atau email..."
              />
            </div>

            <button
              class="btn btn-primary"
              id="loadEmployeesBtn"
              style="width: 100%; margin-bottom: 20px"
            >
              <i class="fas fa-sync"></i> Muat Data Karyawan
            </button>
            <div id="employeesList"></div>
          </div>

          <!-- Roles Tab -->
          <div class="tab-content" id="roles">
            <form id="roleForm">
              <div class="form-row">
                <div class="form-group">
                  <label for="roleName">Nama Jabatan*:</label>
                  <input type="text" id="roleName" required placeholder="e.g., Staff, Manager" />
                </div>
                <div class="form-group">
                  <label for="checkInTime">Jam Masuk:</label>
                  <input type="time" id="checkInTime" />
                </div>
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%">
                <i class="fas fa-plus"></i> Tambah Jabatan
              </button>
            </form>
            <div id="roleStatus"></div>
            <hr style="margin: 20px 0;" />
            <button class="btn btn-primary" id="loadRolesBtn" style="width: 100%; margin-bottom: 20px">
              <i class="fas fa-sync"></i> Muat Data Jabatan
            </button>
            <div id="rolesList"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Employee Edit Modal -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2><i class="fas fa-edit"></i> Edit Karyawan</h2>
        <form id="editEmployeeForm">
          <input type="hidden" id="editEmployeeId" />

          <div class="form-group">
            <label for="editName">Nama Lengkap:</label>
            <input type="text" id="editName" required />
          </div>

          <div class="form-group">
            <label for="editAddress">Alamat:</label>
            <textarea id="editAddress"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="editDateOfBirth">Tanggal Lahir:</label>
              <input type="date" id="editDateOfBirth" />
            </div>
            <div class="form-group">
              <label for="editPhone">Telepon:</label>
              <input type="tel" id="editPhone" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="editEmail">Email:</label>
              <input type="email" id="editEmail" />
            </div>
            <div class="form-group">
              <label for="editBasicSalary">Gaji Pokok:</label>
              <input type="number" id="editBasicSalary" min="0" step="1000" />
            </div>
          </div>

          <div class="form-group">
            <label for="editRoleSelect">Jabatan:</label>
            <select id="editRoleSelect" class="form-control"></select>
          </div>

          <div class="btn-group">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Simpan Perubahan
            </button>
            <button type="button" class="btn btn-danger" id="cancelEditBtn">
              <i class="fas fa-times"></i> Batal
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      class AttendanceSystem {
        constructor() {
          this.video = document.getElementById("videoElement");
          this.stream = null;
          this.isDetecting = false;
          this.faceOverlays = [];
          this.API_BASE = "http://localhost:5959/api";
          this.currentEditEmployeeId = null;
          this.init();
        }

        init() {
          this.setupEventListeners();
          this.setupTabs();
          this.setupModal();
          this.checkServerHealth();
          this.loadRoles();
        }

        setupEventListeners() {
          document
            .getElementById("startCameraBtn")
            .addEventListener("click", () => this.startCamera());
          document
            .getElementById("stopCameraBtn")
            .addEventListener("click", () => this.stopCamera());
          document
            .getElementById("checkInBtn")
            .addEventListener("click", () =>
              this.performAttendance("check_in")
            );
          document
            .getElementById("checkOutBtn")
            .addEventListener("click", () =>
              this.performAttendance("check_out")
            );
          document
            .getElementById("registrationForm")
            .addEventListener("submit", (e) => this.registerEmployee(e));
          document
            .getElementById("loadEmployeesBtn")
            .addEventListener("click", () => this.loadEmployees());
          document
            .getElementById("employeeSearch")
            .addEventListener("input", (e) =>
              this.searchEmployees(e.target.value)
            );
          document
            .getElementById("editEmployeeForm")
            .addEventListener("submit", (e) => this.updateEmployee(e));
          document
            .getElementById("roleForm")
            .addEventListener("submit", (e) => this.createRole(e));
          document
            .getElementById("loadRolesBtn")
            .addEventListener("click", () => this.loadRoles());

          // Handle window resize to recalculate overlays
          window.addEventListener("resize", () => {
            if (this.faceOverlays.length > 0) {
              this.clearFaceOverlays();
            }
          });
        }

        setupTabs() {
          const tabs = document.querySelectorAll(".tab");
          tabs.forEach((tab) => {
            tab.addEventListener("click", () => {
              const targetTab = tab.getAttribute("data-tab");

              document
                .querySelectorAll(".tab")
                .forEach((t) => t.classList.remove("active"));
              document
                .querySelectorAll(".tab-content")
                .forEach((c) => c.classList.remove("active"));

              tab.classList.add("active");
              document.getElementById(targetTab).classList.add("active");
            });
          });
        }

        setupModal() {
          const modal = document.getElementById("editModal");
          const closeBtn = document.querySelector(".close");
          const cancelBtn = document.getElementById("cancelEditBtn");

          closeBtn.addEventListener("click", () => {
            modal.style.display = "none";
          });

          cancelBtn.addEventListener("click", () => {
            modal.style.display = "none";
          });

          window.addEventListener("click", (event) => {
            if (event.target === modal) {
              modal.style.display = "none";
            }
          });
        }

        async checkServerHealth() {
          try {
            const response = await fetch(`${this.API_BASE}/health`);
            const result = await response.json();
            if (result.success) {
              this.showStatus(
                "success",
                `Server aktif. ${result.registered_employees} karyawan terdaftar.`
              );
            }
          } catch (error) {
            this.showStatus(
              "error",
              "Tidak dapat terhubung ke server. Pastikan server berjalan di http://localhost:5959"
            );
          }
        }

        async startCamera() {
          try {
            this.stream = await navigator.mediaDevices.getUserMedia({
              video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: "user",
              },
            });
            this.video.srcObject = this.stream;

            this.video.addEventListener("loadedmetadata", () => {
              console.log(
                `Video dimensions: ${this.video.videoWidth}x${this.video.videoHeight}`
              );
              console.log(
                `Display dimensions: ${this.video.clientWidth}x${this.video.clientHeight}`
              );
            });

            document.getElementById("startCameraBtn").disabled = true;
            document.getElementById("stopCameraBtn").disabled = false;
            document.getElementById("checkInBtn").disabled = false;
            document.getElementById("checkOutBtn").disabled = false;

            setTimeout(() => {
              this.startFaceDetection();
            }, 1000);

            this.showStatus("success", "Kamera berhasil diaktifkan");
          } catch (error) {
            this.showStatus(
              "error",
              "Gagal mengakses kamera: " + error.message
            );
          }
        }

        stopCamera() {
          if (this.stream) {
            this.stream.getTracks().forEach((track) => track.stop());
            this.video.srcObject = null;
            this.stream = null;
          }

          this.isDetecting = false;
          this.clearFaceOverlays();
          document.getElementById("faceDetectionInfo").style.display = "none";

          document.getElementById("startCameraBtn").disabled = false;
          document.getElementById("stopCameraBtn").disabled = true;
          document.getElementById("checkInBtn").disabled = true;
          document.getElementById("checkOutBtn").disabled = true;

          this.showStatus("info", "Kamera dihentikan");
        }

        startFaceDetection() {
          this.isDetecting = true;
          this.detectFaces();
        }

        async detectFaces() {
          if (!this.isDetecting || !this.stream) return;

          try {
            const imageData = this.captureFrame();
            const response = await fetch(`${this.API_BASE}/detect-faces`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ image: imageData }),
            });

            const result = await response.json();
            if (result.success) {
              this.updateFaceOverlays(result.faces, result.image_size);
              document.getElementById("faceDetectionInfo").style.display =
                "block";
              document.getElementById(
                "faceCount"
              ).textContent = `Wajah terdeteksi: ${result.count}`;
            }
          } catch (error) {
            console.error("Face detection error:", error);
          }

          setTimeout(() => this.detectFaces(), 300);
        }

        updateFaceOverlays(faces, originalImageSize) {
          this.clearFaceOverlays();

          if (!faces || faces.length === 0) return;

          const videoRect = this.video.getBoundingClientRect();
          const displayedWidth = this.video.clientWidth;
          const displayedHeight = this.video.clientHeight;

          const originalWidth = originalImageSize
            ? originalImageSize.width
            : this.video.videoWidth;
          const originalHeight = originalImageSize
            ? originalImageSize.height
            : this.video.videoHeight;

          const scaleX = displayedWidth / originalWidth;
          const scaleY = displayedHeight / originalHeight;

          faces.forEach((face, index) => {
            const overlay = document.createElement("div");
            overlay.className = "face-overlay";
            overlay.id = `face-overlay-${index}`;

            const scaledX = face.x * scaleX;
            const scaledY = face.y * scaleY;
            const scaledWidth = face.width * scaleX;
            const scaledHeight = face.height * scaleY;

            overlay.style.left = scaledX + "px";
            overlay.style.top = scaledY + "px";
            overlay.style.width = scaledWidth + "px";
            overlay.style.height = scaledHeight + "px";

            const label = document.createElement("div");
            label.style.cssText = `
                        position: absolute;
                        top: -25px;
                        left: 0;
                        background: rgba(16, 185, 129, 0.9);
                        color: white;
                        padding: 2px 8px;
                        border-radius: 4px;
                        font-size: 12px;
                        font-weight: bold;
                        white-space: nowrap;
                    `;
            label.textContent = `Face ${index + 1}`;
            overlay.appendChild(label);

            this.video.parentElement.appendChild(overlay);
            this.faceOverlays.push(overlay);
          });
        }

        clearFaceOverlays() {
          this.faceOverlays.forEach((overlay) => overlay.remove());
          this.faceOverlays = [];
        }

        captureFrame() {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");

          const videoWidth = this.video.videoWidth || 640;
          const videoHeight = this.video.videoHeight || 480;

          canvas.width = videoWidth;
          canvas.height = videoHeight;

          ctx.drawImage(this.video, 0, 0, videoWidth, videoHeight);

          return canvas.toDataURL("image/jpeg", 0.8);
        }

        async performAttendance(eventType) {
          if (!this.stream) {
            this.showStatus("error", "Kamera belum diaktifkan");
            return;
          }

          const button = document.getElementById(
            eventType === "check_in" ? "checkInBtn" : "checkOutBtn"
          );
          const originalText = button.innerHTML;

          try {
            button.innerHTML = '<span class="loading"></span> Memproses...';
            button.disabled = true;

            const imageData = this.captureFrame();
            const response = await fetch(`${this.API_BASE}/attendance`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                image: imageData,
                event_type: eventType,
              }),
            });

            const result = await response.json();

            if (result.success) {
              this.showStatus("success", result.message);
              if (result.employee_info) {
                this.displayEmployeeInfo(
                  result.employee_info,
                  result.attendance_info
                );
              }
            } else {
              this.showStatus("error", result.message);
            }
          } catch (error) {
            this.showStatus("error", "Error: " + error.message);
          } finally {
            button.innerHTML = originalText;
            button.disabled = false;
          }
        }

        displayEmployeeInfo(employee, attendance) {
          const infoDiv = document.createElement("div");
          infoDiv.className = "employee-info";
          infoDiv.innerHTML = `
                    <h3>${employee.name}</h3>
                    <p>ID: ${employee.employee_id}</p>
                    <p>Tanggal: ${attendance.date}</p>
                    <p>Waktu: ${attendance.time}</p>
                    <p>Aktivitas: ${
                      attendance.event_type === "check_in"
                        ? "Check In"
                        : "Check Out"
                    }</p>
                `;

          const existingInfo = document.querySelector(".employee-info");
          if (existingInfo) {
            existingInfo.replaceWith(infoDiv);
          } else {
            document.getElementById("attendanceStatus").appendChild(infoDiv);
          }
        }

        async registerEmployee(e) {
          e.preventDefault();

          if (!this.stream) {
            this.showStatus(
              "error",
              "Kamera belum diaktifkan untuk mengambil foto",
              "registrationStatus"
            );
            return;
          }

          const employeeId = document.getElementById("employeeId").value;
          const name = document.getElementById("name").value;
          const address = document.getElementById("address").value;
          const dateOfBirth = document.getElementById("dateOfBirth").value;
          const phone = document.getElementById("phone").value;
          const email = document.getElementById("email").value;
          const basicSalary = document.getElementById("basicSalary").value;
          const roleName = document.getElementById("roleSelect").value;

          const button = document.getElementById("registerBtn");
          const originalText = button.innerHTML;

          try {
            button.innerHTML = '<span class="loading"></span> Mendaftarkan...';
            button.disabled = true;

            const imageData = this.captureFrame();
            const response = await fetch(`${this.API_BASE}/register`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                employee_id: employeeId,
                name: name,
                address: address,
                date_of_birth: dateOfBirth,
                phone: phone,
                email: email,
                basic_salary: basicSalary ? parseFloat(basicSalary) : null,
                image: imageData,
                role_name: roleName,
              }),
            });

            const result = await response.json();

            if (result.success) {
              this.showStatus("success", result.message, "registrationStatus");
              document.getElementById("registrationForm").reset();
              this.loadEmployees();
            } else {
              this.showStatus("error", result.message, "registrationStatus");
            }
          } catch (error) {
            this.showStatus(
              "error",
              "Error: " + error.message,
              "registrationStatus"
            );
          } finally {
            button.innerHTML = originalText;
            button.disabled = false;
          }
        }

        async loadEmployees() {
          const button = document.getElementById("loadEmployeesBtn");
          const originalText = button.innerHTML;

          try {
            button.innerHTML = '<span class="loading"></span> Memuat...';
            button.disabled = true;

            const response = await fetch(`${this.API_BASE}/employees`);
            const result = await response.json();

            if (result.success) {
              this.displayEmployees(result.employees);
            } else {
              this.showStatus("error", "Gagal memuat data karyawan");
            }
          } catch (error) {
            this.showStatus("error", "Error: " + error.message);
          } finally {
            button.innerHTML = originalText;
            button.disabled = false;
          }
        }

        async searchEmployees(searchTerm) {
          if (searchTerm.trim() === "") {
            this.loadEmployees();
            return;
          }

          try {
            const response = await fetch(
              `${this.API_BASE}/employees/search?q=${encodeURIComponent(
                searchTerm
              )}`
            );
            const result = await response.json();

            if (result.success) {
              this.displayEmployees(result.employees);
            } else {
              this.showStatus("error", "Gagal mencari karyawan");
            }
          } catch (error) {
            console.error("Search error:", error);
          }
        }

        displayEmployees(employees) {
          const container = document.getElementById("employeesList");
          if (employees.length === 0) {
            container.innerHTML =
              '<p style="text-align: center; color: #64748B;">Belum ada karyawan terdaftar</p>';
            return;
          }

          container.innerHTML = employees
            .map(
              (emp) => `
                <div class="employee-card">
                  <h4>${emp.name}</h4>
                  <div class="employee-details">
                    <div><strong>ID:</strong> ${emp.employee_id}</div>
                    <div><strong>Email:</strong> ${emp.email || "-"}</div>
                    <div><strong>Telepon:</strong> ${emp.phone || "-"}</div>
                    <div><strong>Tgl. Lahir:</strong> ${
                      emp.date_of_birth
                        ? new Date(emp.date_of_birth).toLocaleDateString(
                            "id-ID"
                          )
                        : "-"
                    }</div>
                    <div><strong>Gaji:</strong> ${
                      emp.basic_salary
                        ? `Rp ${parseInt(emp.basic_salary).toLocaleString(
                            "id-ID"
                          )}`
                        : "-"
                    }</div>
                    <div><strong>Jabatan:</strong> ${emp.role_name || "-"}</div>
                    <div><strong>Bergabung:</strong> ${new Date(
                      emp.created_at
                    ).toLocaleDateString("id-ID")}</div>
                  </div>
                  ${
                    emp.address
                      ? `<div style="margin-top: 8px;"><strong>Alamat:</strong> ${emp.address}</div>`
                      : ""
                  }
                  <div class="employee-actions">
                    <button class="btn btn-primary btn-small" onclick="attendanceSystem.editEmployee('${
                      emp.employee_id
                    }')">
                      <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-danger btn-small" onclick="attendanceSystem.deleteEmployee('${
                      emp.employee_id
                    }')">
                      <i class="fas fa-trash"></i> Hapus
                    </button>
                    <button class="btn btn-success btn-small" onclick="attendanceSystem.viewAttendance('${
                      emp.employee_id
                    }')">
                      <i class="fas fa-chart-line"></i> Absensi
                    </button>
                  </div>
                </div>
              `
            )
            .join("");
        }

        async editEmployee(employeeId) {
          try {
            const response = await fetch(
              `${this.API_BASE}/employees/${employeeId}`
            );
            const result = await response.json();

            if (result.success) {
              const emp = result.employee;
              this.currentEditEmployeeId = employeeId;

              document.getElementById("editEmployeeId").value = emp.employee_id;
              document.getElementById("editName").value = emp.name;
              document.getElementById("editAddress").value = emp.address || "";
              document.getElementById("editDateOfBirth").value =
                emp.date_of_birth || "";
              document.getElementById("editPhone").value = emp.phone || "";
              document.getElementById("editEmail").value = emp.email || "";
              document.getElementById("editBasicSalary").value =
                emp.basic_salary || "";
              document.getElementById("editRoleSelect").value = emp.role_name || "";

              document.getElementById("editModal").style.display = "block";
            } else {
              this.showStatus("error", "Gagal memuat data karyawan");
            }
          } catch (error) {
            this.showStatus("error", "Error: " + error.message);
          }
        }

        async updateEmployee(e) {
          e.preventDefault();

          if (!this.currentEditEmployeeId) return;

          const formData = {
            name: document.getElementById("editName").value,
            address: document.getElementById("editAddress").value,
            date_of_birth: document.getElementById("editDateOfBirth").value,
            phone: document.getElementById("editPhone").value,
            email: document.getElementById("editEmail").value,
            basic_salary: document.getElementById("editBasicSalary").value
              ? parseFloat(document.getElementById("editBasicSalary").value)
              : null,
            role_name: document.getElementById("editRoleSelect").value,
          };

          try {
            const response = await fetch(
              `${this.API_BASE}/employees/${this.currentEditEmployeeId}`,
              {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formData),
              }
            );

            const result = await response.json();

            if (result.success) {
              this.showStatus("success", "Data karyawan berhasil diperbarui");
              document.getElementById("editModal").style.display = "none";
              this.loadEmployees();
            } else {
              this.showStatus("error", result.message);
            }
          } catch (error) {
            this.showStatus("error", "Error: " + error.message);
          }
        }

        async deleteEmployee(employeeId) {
          if (
            !confirm(
              "Apakah Anda yakin ingin menghapus karyawan ini? Semua data absensi akan ikut terhapus."
            )
          ) {
            return;
          }

          try {
            const response = await fetch(
              `${this.API_BASE}/employees/${employeeId}`,
              {
                method: "DELETE",
              }
            );

            const result = await response.json();

            if (result.success) {
              this.showStatus("success", "Karyawan berhasil dihapus");
              this.loadEmployees();
            } else {
              this.showStatus("error", result.message);
            }
          } catch (error) {
            this.showStatus("error", "Error: " + error.message);
          }
        }

        async createRole(e) {
          e.preventDefault();
          const roleName = document.getElementById("roleName").value;
          const checkInTime = document.getElementById("checkInTime").value;

          try {
            const response = await fetch(`${this.API_BASE}/roles`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                role_name: roleName, 
                expected_check_in_time: checkInTime ? checkInTime : null 
              }),
            });

            const result = await response.json();

            if (result.success) {
              this.showStatus("success", result.message, "roleStatus");
              document.getElementById("roleForm").reset();
              this.loadRoles();
            } else {
              this.showStatus("error", result.message, "roleStatus");
            }
          } catch (error) {
            this.showStatus("error", "Error: " + error.message, "roleStatus");
          }
        }

        async loadRoles() {
          try {
            const response = await fetch(`${this.API_BASE}/roles`);
            const result = await response.json();

            if (result.success) {
              this.displayRoles(result.roles);
              this.populateRoleDropdowns(result.roles);
            } else {
              this.showStatus("error", "Gagal memuat data jabatan", "roleStatus");
            }
          } catch (error) {
            this.showStatus("error", "Error: " + error.message, "roleStatus");
          }
        }

        displayRoles(roles) {
          const container = document.getElementById("rolesList");
          if (roles.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #64748B;">Belum ada jabatan terdaftar</p>';
            return;
          }

          container.innerHTML = roles
            .map(
              (role) => `
                <div class="employee-card">
                  <h4>${role.role_name}</h4>
                  <div class="employee-details">
                    <div><strong>Jam Masuk:</strong> ${role.expected_check_in_time || "-"}</div>
                  </div>
                  <div class="employee-actions">
                    <button class="btn btn-danger btn-small" onclick="attendanceSystem.deleteRole('${role.role_name}')">
                      <i class="fas fa-trash"></i> Hapus
                    </button>
                  </div>
                </div>
              `
            )
            .join("");
        }

        async deleteRole(roleName) {
          if (!confirm(`Apakah Anda yakin ingin menghapus jabatan "${roleName}"?`)) {
            return;
          }

          try {
            const response = await fetch(`${this.API_BASE}/roles/${roleName}`, {
              method: "DELETE",
            });

            const result = await response.json();

            if (result.success) {
              this.showStatus("success", "Jabatan berhasil dihapus", "roleStatus");
              this.loadRoles();
            } else {
              this.showStatus("error", result.message, "roleStatus");
            }
          } catch (error) {
            this.showStatus("error", "Error: " + error.message, "roleStatus");
          }
        }

        populateRoleDropdowns(roles) {
          const roleSelect = document.getElementById("roleSelect");
          const editRoleSelect = document.getElementById("editRoleSelect");

          roleSelect.innerHTML = '<option value="">Pilih Jabatan</option>';
          editRoleSelect.innerHTML = '<option value="">Pilih Jabatan</option>';

          roles.forEach(role => {
            const option = document.createElement("option");
            option.value = role.role_name;
            option.textContent = role.role_name;
            roleSelect.appendChild(option.cloneNode(true));
            editRoleSelect.appendChild(option);
          });
        }

        async viewAttendance(employeeId) {
          try {
            const response = await fetch(
              `${this.API_BASE}/attendance/status/${employeeId}`
            );
            const result = await response.json();

            if (result.success) {
              const status = result.status;
              let statusMessage = `Status Absensi Hari Ini:\n\n`;
              statusMessage += `Employee ID: ${status.employee_id}\n`;
              statusMessage += `Tanggal: ${status.date}\n`;
              statusMessage += `Status: ${this.getStatusText(status.status)}\n`;

              if (status.check_in_time) {
                statusMessage += `Check In: ${status.check_in_time}\n`;
              }
              if (status.check_out_time) {
                statusMessage += `Check Out: ${status.check_out_time}\n`;
              }
              if (status.total_hours > 0) {
                statusMessage += `Total Jam: ${status.total_hours} jam\n`;
              }

              statusMessage += `\n${status.message}`;

              alert(statusMessage);
            } else {
              this.showStatus("error", "Gagal memuat status absensi");
            }
          } catch (error) {
            this.showStatus("error", "Error: " + error.message);
          }
        }

        getStatusText(status) {
          const statusMap = {
            present: "Hadir",
            partial: "Partial",
            absent: "Tidak Hadir",
            not_started: "Belum Mulai",
          };
          return statusMap[status] || status;
        }

        showStatus(type, message, elementId = "attendanceStatus") {
          const element = document.getElementById(elementId);
          element.innerHTML = `<div class="status ${type}">${message}</div>`;

          if (type === "success") {
            setTimeout(() => {
              element.innerHTML = "";
            }, 5000);
          }
        }
      }

      // Make attendanceSystem globally accessible for onclick handlers
      let attendanceSystem;

      document.addEventListener("DOMContentLoaded", () => {
        attendanceSystem = new AttendanceSystem();
      });
    </script>
  </body>
</html>
